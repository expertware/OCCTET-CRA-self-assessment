eCREATE SCHEMA ORG;

CREATE TABLE ORG.COUNTRIES (ID SERIAL PRIMARY KEY, NAME VARCHAR(50) NOT NULL);

CREATE TABLE ORG.ACTIVITY_SECTORS (
	ID SERIAL PRIMARY KEY,
	NAME VARCHAR(500) NOT NULL,
	EXEMPLES TEXT NULL
);

ALTER TABLE ORG.ACTIVITY_SECTORS
ADD ACTIVITY_SECTOR_ID INT NULL REFERENCES ORG.ACTIVITY_SECTORS (ID);


CREATE TABLE ORG.ORGANISATIONS (
	ID SERIAL PRIMARY KEY,
	NAME VARCHAR(500) NOT NULL,
	VAT TEXT NOT NULL,
	COUNTRY_ID INT NOT NULL REFERENCES ORG.COUNTRIES (ID),
	ACCESS_CODE TEXT NOT NULL,
	DOMAIN TEXT NOT NULL,
	COMPANY_SIZE VARCHAR(200) NOT NULL,
	CONTACT_PERSON_ROLE VARCHAR(200) NOT NULL,
	CONTACT_PERSON_NAME VARCHAR(500) NOT NULL,
	CONTACT_PERSON_EMAIL VARCHAR(500) NOT NULL,
	ORGANIZATION_SURVEY_ID INT NULL,
	CONFIRM_REGISTER BOOLEAN NULL,
	CONFIRM_EMAIL BOOLEAN NULL
);

CREATE TABLE ORG.DELIVERY_COUNTRIES (
	ID SERIAL PRIMARY KEY,
	COUNTRY_ID INT NOT NULL REFERENCES ORG.COUNTRIES (ID),
	ORGANISATION_ID INT NOT NULL REFERENCES ORG.ORGANISATIONS (ID)
);

CREATE TABLE ORG.ORGANISATION_SECTORS (
	ID SERIAL PRIMARY KEY,
	ACTIVITY_SECTOR_ID INT NOT NULL REFERENCES ORG.ACTIVITY_SECTORS (ID),
	ORGANISATION_ID INT NOT NULL REFERENCES ORG.ORGANISATIONS (ID)
);
---
CREATE SCHEMA SRV;


CREATE TABLE PUBLIC.TENANT_CONFIGURATIONS (
	ID SERIAL PRIMARY KEY,
	TENANT_IDC INT NOT NULL REFERENCES PUBLIC.TENANTS (ID),
	OFFICE_NOTIFY BIT NULL,
	OFFICE_TIMER INT NULL,
	AZURE_NOTIFY BIT NULL,
	AZURE_TIMER INT NULL,
	ON_PREM_NOTIFY BIT NULL,
	ON_PREM_TIMER INT NULL,
	SCRIPTS_NOTIFY BIT NULL,
	LOCK_NOTIFICATION TIMESTAMP DEFAULT CURRENT_TIMESTAMP NULL
);

CREATE TABLE SRV.SURVEY_SECTIONS (
	ID SERIAL PRIMARY KEY,
	NAME VARCHAR(500) NOT NULL,
	DESCRIPTION TEXT NULL,
	SURVEY_ID INT NOT NULL REFERENCES SRV.SURVEYS (ID),
	IS_DELETED BOOLEAN NULL
);

CREATE TABLE SRV.QUESTION_TYPES (ID SERIAL PRIMARY KEY, NAME VARCHAR(50) NOT NULL);

CREATE TABLE SRV.QUESTIONS (
	ID SERIAL PRIMARY KEY,
	NAME VARCHAR(500) NOT NULL,
	DESCRIPTION TEXT NULL,
	SECTION_ID INT NOT NULL REFERENCES SRV.SURVEY_SECTIONS (ID),
	QUESTION_TYPE_ID INT NOT NULL REFERENCES SRV.QUESTION_TYPES (ID),
	IS_DELETED BOOLEAN NOT NULL
);

CREATE TABLE SRV.answers_prompts (
	ID SERIAL PRIMARY KEY,
	QUESTION_ID INT NOT NULL REFERENCES SRV.QUESTIONS (ID),
	ANSWERS TEXT NOT NULL,
	PROMPT TEXT NULL
);

CREATE TABLE SRV.ATTACHMENTS (
	ID SERIAL PRIMARY KEY,
	NAME VARCHAR(500) NOT NULL,
	CONTENT TEXT NOT NULL,
	CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	IS_DELETED BOOLEAN NOT NULL
);

CREATE TABLE SRV.QUESTION_ATTACHMENTS (
	ID SERIAL PRIMARY KEY,
	QUESTION_ID INT NOT NULL REFERENCES SRV.QUESTIONS (ID),
	ATTACHMENT_ID INT NOT NULL REFERENCES SRV.ATTACHMENTS (ID)
);

CREATE TABLE SRV.ORGANISATION_SURVEYS (
	ID SERIAL PRIMARY KEY,
	ORGANISATION_ID INT  NULL REFERENCES ORG.ORGANISATIONS (ID),
	CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	SURVEY_ID INT NOT NULL REFERENCES SRV.SURVEYS (ID),
	RESULT TEXT NULL
);

CREATE TABLE SRV.SURVEY_RESPONSES (
	ID SERIAL PRIMARY KEY,
	ORGANISATION_SURVEY_ID INT NOT NULL REFERENCES SRV.ORGANISATION_SURVEYS (ID) Delete,
	QUESTION_ID INT NOT NULL REFERENCES SRV.QUESTIONS (ID),
	RESPONSE TEXT NOT NULL
);

ALTER TABLE ORG.DELIVERY_COUNTRIES
DROP CONSTRAINT DELIVERY_COUNTRIES_ORGANISATION_ID_FKEY;

ALTER TABLE ORG.DELIVERY_COUNTRIES
ADD CONSTRAINT DELIVERY_COUNTRIES_ORGANISATION_ID_FKEY FOREIGN KEY (ORGANISATION_ID) REFERENCES ORG.ORGANISATIONS (ID) ON DELETE CASCADE;

CREATE TABLE SRV.ANSWERS_PROMPTS (
	ID SERIAL PRIMARY KEY,
	QUESTION_ID INT NOT NULL REFERENCES SRV.QUESTIONS (ID),
	ANSWERS TEXT NOT NULL,
	PROMPT TEXT NOT NULL
);

ALTER TABLE SRV.SURVEY_SECTIONS
ADD COLUMN PARENT_SECTION_ID INT NULL REFERENCES SRV.SURVEY_SECTIONS (ID);

ALTER TABLE SRV.QUESTIONS
ADD COLUMN POSITION INT NULL;

ALTER TABLE SRV.QUESTIONS
ADD PARRENT_ANSWER_ID INT NULL REFERENCES SRV.ANSWERS_PROMPTS;

ALTER TABLE SRV.SURVEYS
ADD COLUMN IS_PUBLIC BOOL NULL;

ALTER TABLE ORG.ORGANISATIONS
ADD COLUMN CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP;

ALTER TABLE SRV.ANSWERS_PROMPTS
ADD COLUMN COMMENT VARCHAR(500) NULL;

ALTER TABLE SRV.SURVEY_RESPONSES
ADD COLUMN MENTIONS TEXT NULL;

ALTER TABLE ORG.COUNTRIES
ADD IS_EUROPEAN BOOL NULL;

ALTER TABLE org.organisation_sectors
DROP CONSTRAINT organisation_sectors_organisation_id_fkey;

ALTER TABLE org.organisation_sectors
ADD CONSTRAINT organisation_sectors_organisation_id_fkey
FOREIGN KEY (organisation_id)
REFERENCES org.organisations (id)
ON DELETE CASCADE;

ALTER TABLE SRV.SURVEY_RESPONSES
ADD CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP;

ALTER TABLE SRV.SURVEY_RESPONSES
ADD UPDATE_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP;

ALTER TABLE SRV.SURVEY_RESPONSES
ADD CONSTRAINT UQ_SURVEY_RESPONSES_QUESTION_ID_SURVEY_ID UNIQUE (QUESTION_ID, ORGANISATION_SURVEY_ID);

ALTER TABLE ORG.ORGANISATIONS
ADD IS_DELETED BOOL NULL;

ALTER TABLE auth."AspNetUserRoles"
ADD COLUMN ID SERIAL;

ALTER TABLE AUTH."AspNetUsers"
ADD COLUMN "Name" VARCHAR(200);

ALTER TABLE AUTH."AspNetUsers"
ADD COLUMN "IsDeleted" BOOL;

ALTER TABLE ORG.ORGANISATIONS
ADD COLUMN UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP;

ALTER TABLE ORG.ORGANISATIONS
ADD COLUMN CONFIRM_EMAIL_CODE varchar(100) NULL;

INSERT INTO auth."AspNetRoles" (
    "Name", "NormalizedName", "ConcurrencyStamp"
) VALUES
    ('Request Approver', 'REQUEST APPROVER', gen_random_uuid()),
    ('Raports Viewer', 'RAPORTS VIEWER', gen_random_uuid()),
    ('Admin', 'ADMIN', gen_random_uuid());



CREATE OR REPLACE VIEW srv.vw_organisation_results
 AS
 WITH rez AS (
         SELECT org_srv.id,
            org_srv.created_at,
            org_srv.updated_at,
            organisation.id AS organisation_id,
            organisation.name AS organisation_name,
            org_srv.survey_id,
            org_srv.result,
            organisation.country_id,
            country.name AS country_name,
            organisation.company_size,
            org_sec.activity_sector_id,
            sec.name AS activity_sector_name,
            rank() OVER (PARTITION BY org_srv.organisation_id, org_srv.survey_id ORDER BY org_srv.updated_at DESC) AS rnk
           FROM srv.organisation_surveys org_srv
             JOIN org.organisations organisation ON organisation.id = org_srv.organisation_id
             JOIN org.organisation_sectors org_sec ON org_sec.organisation_id = organisation.id
             JOIN org.activity_sectors sec ON sec.id = org_sec.activity_sector_id
             JOIN org.countries country ON country.id = organisation.country_id
			  where  org_srv.result is not null
        )
 SELECT id,
    created_at,
    updated_at,
    organisation_id,
    organisation_name,
    survey_id,
    result,
    country_id,
    country_name,
    company_size,
    activity_sector_id,
    activity_sector_name
   FROM rez
  WHERE rnk = 1;

ALTER TABLE srv.vw_organisation_results
    OWNER TO postgres;



3CREATE VIEW SRV.VW_SECTION_REPORTS AS
WITH
	REZ AS (
		SELECT
			RES.ID,
			SEC.NAME,
			RES.RESPONSE,
			RES.QUESTION_ID,
			RES.ORGANISATION_SURVEY_ID,
			SEC.SURVEY_ID,
			ORGANISATION.COUNTRY_ID,
			ORG_SRV.CREATED_AT,
			ORGANISATION.COMPANY_SIZE,
			ORG_SECTOR.ACTIVITY_SECTOR_ID,
			ORG_SRV.RESULT,
			RANK() OVER (
				PARTITION BY
					ORG_SRV.ORGANISATION_ID,
					ORG_SRV.SURVEY_ID
				ORDER BY
					ORG_SRV.UPDATED_AT DESC
			) AS RNK
		FROM
			SRV.SURVEY_RESPONSES RES
			JOIN SRV.QUESTIONS QST ON QST.ID = RES.QUESTION_ID
			JOIN SRV.SURVEY_SECTIONS SEC ON SEC.ID = QST.SECTION_ID
			JOIN SRV.ORGANISATION_SURVEYS ORG_SRV ON ORG_SRV.ID = RES.ORGANISATION_SURVEY_ID
			LEFT JOIN ORG.ORGANISATIONS ORGANISATION ON ORGANISATION.ID = ORG_SRV.ORGANISATION_ID
			LEFT JOIN ORG.ORGANISATION_SECTORS ORG_SECTOR ON ORG_SECTOR.ORGANISATION_ID = ORG_SRV.ORGANISATION_ID
		WHERE
			ORG_SRV.RESULT IS NOT NULL
	)
SELECT
	ID,
	NAME,
	RESPONSE,
	QUESTION_ID,
	ORGANISATION_SURVEY_ID,
	SURVEY_ID,
	COUNTRY_ID,
	CREATED_AT,
	COMPANY_SIZE,
	ACTIVITY_SECTOR_ID,
	RESULT
FROM
	REZ
WHERE
	RNK = 1
-----
ALTER TABLE ORG.ORGANISATIONS
ADD COLUMN ACCOUNT_ID TEXT NOT NULL REFERENCES "auth"."AspNetUsers" ("Id");
insert into auth."AspNetRoles" ("Id", "Name", "NormalizedName") values('0db07f25-165c-4d48-92c1-18770e23bd30','Guest', 'GUEST')



////CLEAN
DELETE FROM ORG.ORGANISATION_SECTORS;

DELETE FROM ORG.DELIVERY_COUNTRIES;

DELETE FROM SRV.SURVEY_RESPONSES;

DELETE FROM SRV.ORGANISATION_SURVEYS;

DELETE FROM ORG.ORGANISATIONS;